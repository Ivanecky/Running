---
title: "XC Analysis"
author: "Samuel Ivanecky"
date: "1/14/2020"
output: html_document
---
# SETUP
```{r setup, include=FALSE}
# Libraries
library(ggplot2)
library(tidyverse)
library(data.table)
library(rvest)
library(forecast)
library(XML)

# Set WD
setwd("~/Desktop/XC/Running/")
```

# GRAB XC RESULTS
```{r}
# To run for D1, womens tables are first except 2013.
# To run for D2, need to flip order of mens and womens tables.
# XC results - 2019
xc19 = 'https://www.tfrrs.org/results/xc/16731/NCAA_Division_I_Cross_Country_Championships' # D1
#xc19 = 'https://www.tfrrs.org/results/xc/16713/NCAA_Division_II_Cross_Country_Championships' # D2
# Read webpage into tables
xc19 = read_html(xc19) %>% html_table()

# Extract each table
women_19 = as.data.frame(xc19[[2]])
men_19 = as.data.frame(xc19[[4]])
# XC results - 2018
xc18 = 'https://www.tfrrs.org/results/xc/15036/NCAA_DI_Cross_Country_Championships' # D1
#xc18 = 'https://www.tfrrs.org/results/xc/15037/NCAA_Division_II_Cross_Country_Championships' # D2

# Read webpage into tables
xc18 = read_html(xc18) %>% html_table()

# Extract each table
women_18 = as.data.frame(xc18[[2]])
men_18 = as.data.frame(xc18[[4]])

# XC results - 2017
xc17 = 'https://www.tfrrs.org/results/xc/13423/NCAA_Division_I_Cross_Country_Championships' # D1
#xc17 = 'https://www.tfrrs.org/results/xc/13406/NCAA_Division_II_Cross_Country_Championships' # D2

# Read webpage into tables
xc17 = read_html(xc17) %>% html_table()

# Extract each table
women_17 = as.data.frame(xc17[[2]])
men_17 = as.data.frame(xc17[[4]])

# XC results - 2016
xc16 = 'https://www.tfrrs.org/results/xc/11271/NCAA_Division_I_Cross_Country_Championships' # D1
#xc16 = 'https://www.tfrrs.org/results/xc/11246/NCAA_Division_II_Cross_Country_Championships' # D2

# Read webpage into tables
xc16 = read_html(xc16) %>% html_table()

# Extract each table
women_16 = as.data.frame(xc16[[2]])
men_16 = as.data.frame(xc16[[4]])

# XC results - 2015
xc15 = 'https://www.tfrrs.org/results/xc/9347/NCAA_Division_I_Cross_Country_Championships' # D1
#xc15 = 'https://www.tfrrs.org/results/xc/9348/NCAA_Division_II_Cross_Country_Championships' # D2

# Read webpage into tables
xc15 = read_html(xc15) %>% html_table()

# Extract each table
women_15 = as.data.frame(xc15[[2]])
men_15 = as.data.frame(xc15[[4]])

# XC results - 2014
xc14 = 'https://www.tfrrs.org/results/xc/7652/NCAA_Division_I_Cross_Country_Championships' # D1
#xc14 = 'https://www.tfrrs.org/results/xc/7658/NCAA_Division_II_National_Championships' # D2

# Read webpage into tables
xc14 = read_html(xc14) %>% html_table()

# Extract each table
women_14 = as.data.frame(xc14[[2]])
men_14 = as.data.frame(xc14[[4]])

# XC results - 2013
xc13 = 'https://www.tfrrs.org/results/xc/6218/NCAA_Division_I_Cross_Country_Championships' # D1
#xc13 = 'https://www.tfrrs.org/results/xc/6221/NCAA_Division_II_Cross_Country_Championships' # D2

# Read webpage into tables
xc13 = read_html(xc13) %>% html_table()

# Extract each table - note order is flipped for D1
# For D2, women are first.
women_13 = as.data.frame(xc13[[4]])
men_13 = as.data.frame(xc13[[2]])

# XC results - 2012
xc12 = 'https://www.tfrrs.org/results/xc/4797/2012_NCAA_Division_I_Cross_Country_Championships' # D1
#xc12 = 'https://www.tfrrs.org/results/xc/4796/2012_NCAA_Division_II_Cross_Country_Championships' # D2

# Read webpage into tables
xc12 = read_html(xc12) %>% html_table()

# Extract each table
women_12 = as.data.frame(xc12[[2]])
men_12 = as.data.frame(xc12[[4]])

# Remove HTML objects
rm(xc12, xc13, xc14, xc15, xc16, xc17, xc18, xc19)

```

# CLEAN UP THE DATA
```{r}
# Only grab necessary columns from each year + add var for finish year
# 2019
men_19 = men_19 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_19 = women_19 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2018
men_18 = men_18 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_18 = women_18 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2017
men_17 = men_17 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_17 = women_17 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2016
men_16 = men_16 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_16 = women_16 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2015
men_15 = men_15 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_15= women_15 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2014
men_14 = men_14 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_14 = women_14 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2013
men_13 = men_13 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_13 = women_13 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
# 2012
men_12 = men_12 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
women_12 = women_12 %>%
  select(NAME, TEAM, YEAR, TIME, PL)
```

# CREATE OVERALL DATA SET
```{r}
men = rbind(men_12, men_13, men_14, men_15, men_16, men_17, men_18, men_19)
women = rbind(women_12, women_13, women_14, women_15, women_16, women_17, women_18, women_19)
```

# ONLY FOR D2
# CODE TO ADJUST NAMES FOR PROPER GROUPING
```{r}
# men = separate(men, NAME, c("LAST", "FIRST"))
# men = men %>%
#   mutate(
#     NAME = paste0(FIRST, " ", LAST)
#   ) %>%
#   select(NAME, TEAM, YEAR, PL)
# 
# women = separate(women, NAME, c("LAST", "FIRST"))
# women = women %>%
#   mutate(
#     NAME = paste0(FIRST, " ", LAST)
#   ) %>%
#   select(NAME, TEAM, YEAR, PL)
```

# CREATE YEAR PLACE VARS
```{r}
# Men
men$PL = as.numeric(men$PL)
men_grp = men %>%
  mutate(
    FR.PL = case_when(
      grepl("FR", YEAR) ~ PL,
      T ~ 999
    ),
    SO.PL = case_when(
      grepl("SO", YEAR) ~ PL,
      T ~ 999
    ),
    JR.PL = case_when(
      grepl("JR|3", YEAR) ~ PL,
      T ~ 999
    ),
   SR.PL = case_when(
     grepl("SR", YEAR) ~ PL,
     T ~ 999
   )
  ) %>%
  group_by(NAME) %>%
  summarise(TEAM = min(TEAM), FR = min(FR.PL), SO = min(SO.PL), JR = min(JR.PL), SR = min(SR.PL))

# Women
women$PL = as.numeric(women$PL)
women_grp = women %>%
  mutate(
    FR.PL = case_when(
      grepl("FR", YEAR) ~ PL,
      T ~ 999
    ),
    SO.PL = case_when(
      grepl("SO", YEAR) ~ PL,
      T ~ 999
    ),
    JR.PL = case_when(
      grepl("JR|3", YEAR) ~ PL,
      T ~ 999
    ),
   SR.PL = case_when(
     grepl("SR", YEAR) ~ PL,
     T ~ 999
   )
  ) %>%
  group_by(NAME) %>%
  summarise(TEAM = max(TEAM), FR = min(FR.PL), SO = min(SO.PL), JR = min(JR.PL), SR = min(SR.PL))
```

# HANDLE -999
```{r}
men_grp$FR = ifelse(men_grp$FR == 999, NA, men_grp$FR)
men_grp$SO = ifelse(men_grp$SO == 999, NA, men_grp$SO)
men_grp$JR = ifelse(men_grp$JR == 999, NA, men_grp$JR)
men_grp$SR = ifelse(men_grp$SR == 999, NA, men_grp$SR)

women_grp$FR = ifelse(women_grp$FR == 999, NA, women_grp$FR)
women_grp$SO = ifelse(women_grp$SO == 999, NA, women_grp$SO)
women_grp$JR = ifelse(women_grp$JR == 999, NA, women_grp$JR)
women_grp$SR = ifelse(women_grp$SR == 999, NA, women_grp$SR)
```

# WRITE TO CSV
```{r}
write.csv(men_grp, "MEN_XC_All_Time_D1.csv")
write.csv(women_grp, "WOMEN_XC_All_Time_D1.csv")
```

# EDA
```{r}
# MEN
ggplot(men_grp, aes(FR)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Male FR Finishes") + labs(x = "Finish", y = "Count")
ggplot(men_grp, aes(SO)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Male SO Finishes") + labs(x = "Finish", y = "Count")
ggplot(men_grp, aes(JR)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Male JR Finishes") + labs(x = "Finish", y = "Count")
ggplot(men_grp, aes(SR)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Male SR Finishes") + labs(x = "Finish", y = "Count")

# WOMEN
ggplot(women_grp, aes(FR)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Female FR Finishes") + labs(x = "Finish", y = "Count")
ggplot(women_grp, aes(SO)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Female SO Finishes") + labs(x = "Finish", y = "Count")
ggplot(women_grp, aes(JR)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Female JR Finishes") + labs(x = "Finish", y = "Count")
ggplot(women_grp, aes(SR)) + geom_histogram(bins = 25, colour = "blue", fill = "lightblue") + ggtitle("Distribution of Female SR Finishes") + labs(x = "Finish", y = "Count")

```

# FEATURE ENGINEERING
## CREATE GENDER VAR
```{r}
# Gender var
men_grp$GENDER = "M"
women_grp$GENDER = "F"

# Join two tables together
overall = rbind(men_grp, women_grp)
```

## GET JUMPS PER YEAR
```{r}
overall = overall %>%
  mutate(
    J1 = FR-SO,
    J2 = SO-JR,
    J3 = JR-SR
  )
```

## DISTRIBUTION OF JUMPS
```{r}
ggplot(overall, aes(J1)) + geom_histogram(bins = 35, fill = "lightblue", color = "blue") + ggtitle("Distribution of Jump Between FR & SO YRs")
ggplot(overall, aes(J2)) + geom_histogram(bins = 35, fill = "lightblue", color = "blue") + ggtitle("Distribution of Jump Between SO & JR YRs")
ggplot(overall, aes(J3)) + geom_histogram(bins = 35, fill = "lightblue", color = "blue") + ggtitle("Distribution of Jump Between JR & SR YRs")
```

## DISTRIBUTION OF FINISH BY GRADE
```{r}
# Freshman
fr = ggplot(overall) +
  geom_density(alpha = 0.4, aes(FR, fill = GENDER)) + 
  ggtitle("Distribution of Freshman Finishes") + 
  labs(x = "Finish", y = "Density")

# Sophomore
so = ggplot(overall) +
  geom_density(alpha = 0.4, aes(SO, fill = GENDER)) + 
  ggtitle("Distribution of Sophomore Finishes") + 
  labs(x = "Finish", y = "Density")

# Junior
jr = ggplot(overall) +
  geom_density(alpha = 0.4, aes(JR, fill = GENDER)) + 
  ggtitle("Distribution of Junior Finishes") + 
  labs(x = "Finish", y = "Density")

# Senior
sr = ggplot(overall) +
  geom_density(alpha = 0.4, aes(SR, fill = GENDER)) + 
  ggtitle("Distribution of Senior Finishes") + 
  labs(x = "Finish", y = "Density")

gridExtra::grid.arrange(fr, so, jr, sr)
```

## DISTRIBUTION OF JUMPS BY GENDER
```{r}
# Jump 1
j1 = ggplot(overall) +
  geom_density(alpha = 0.4, aes(J1, fill = GENDER)) + 
  ggtitle("Jump from FR to SO") + 
  labs(x = "Jump in Finish", y = "Density")

# Jump 2
j2 = ggplot(overall) +
  geom_density(alpha = 0.4, aes(J2, fill = GENDER)) + 
  ggtitle("Jump from SO to JR") + 
  labs(x = "Jump in Finish", y = "Density")

# Jump 3
j3 = ggplot(overall) +
  geom_density(alpha = 0.4, aes(J3, fill = GENDER)) + 
  ggtitle("Jump from JR to SR") + 
  labs(x = "Jump in Finish", y = "Density")

gridExtra::grid.arrange(j1, j2, j3)
```

# GROUP ON SCHOOL LEVEL
```{r}
team_overall = overall %>%
  #filter(GENDER == 'F') %>%
  group_by(TEAM) %>%
  summarise(NUM_RUNNERS = n_distinct(NAME), 
            FR.AVG = round(mean(FR, na.rm = T), 2), 
            SO.AVG = round(mean(SO, na.rm = T), 2), 
            JR.AVG = round(mean(JR, na.rm = T), 2), 
            SR.AVG = round(mean(SR, na.rm = T), 2),
            NUM.FR = n_distinct(NAME[!is.na(FR)]), 
            NUM.SO = n_distinct(NAME[!is.na(SO)]),
            NUM.JR = n_distinct(NAME[!is.na(JR)]),
            NUM.SR = n_distinct(NAME[!is.na(SR)]))
```

## SHOW TOP FRESHMAN SCHOOLS
```{r}
# Aggregate by Freshman Finish
freshman = team_overall %>%
  filter(NUM.FR >= 3) %>%
  arrange(FR.AVG)

# Only show top 10
freshman = freshman[1:10, ]

# PLot
ggplot(freshman, aes(reorder(TEAM, FR.AVG), FR.AVG, fill = TEAM)) + 
  geom_bar(stat = "identity") + 
  ggtitle(label = "Best Average Freshman Finish by School", subtitle = "Schools must have at least 3 freshman finishes.") +
  labs(x = "School", y = "Average Finish") +
  geom_text(aes(label=FR.AVG), position=position_dodge(width=0.9), vjust=-0.25) +
  guides(fill=FALSE)

# Aggregate by number of freshman runners
freshman = team_overall %>%
  arrange(-NUM.FR)

# Onlt take top 10
freshman = freshman[1:25, ]

# Plot
ggplot(freshman, aes(reorder(TEAM, -NUM.FR), NUM.FR, fill = TEAM)) + 
  geom_bar(stat = "identity") + 
  ggtitle(label = "Most Freshman Finishes by School") +
  labs(x = "School", y = "Count of Freshman Finishes") +
  geom_text(aes(label=NUM.FR), position=position_dodge(width=0.9), vjust=-0.25) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill=FALSE)
```

# SUBSET TO ONLY RUNNERS WHO HAVE FINISHES FOR ALL 4 YEARS
```{r}
four_years = overall %>%
  filter(!(is.na(FR) | is.na(SO) | is.na(JR) | is.na(SR))) %>%
  #filter(GENDER == "M") %>%
  mutate(
    AVG_FINISH = (FR + SO + JR + SR) / 4
  ) %>%
  arrange(AVG_FINISH)
```

## PLOT OUT TOP RUNNERS BY AVG FINISH
```{r}
# Subset to only top 50
top50 = four_years
# Plot
ggplot(top50, aes(reorder(NAME, AVG_FINISH), AVG_FINISH, fill = NAME)) + 
  geom_bar(stat = "identity") + 
  ggtitle(label = "Best Average Finish - Men", subtitle = "Only runners who have 4 years at NCAAs") +
  labs(x = "Runner", y = "Average Finish") +
  geom_text(aes(label=AVG_FINISH), position=position_dodge(width=0.9), hjust = -0.05, angle = 90) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill=FALSE)
```

```{r}
# Group to team level
team_avg = four_years %>%
  group_by(TEAM) %>%
  summarise(AVG_FINISH = round(mean(AVG_FINISH), 2), NUM_RUNNERS = n_distinct(NAME)) %>%
  filter(NUM_RUNNERS > 1)

# Plot
ggplot(team_avg, aes(reorder(TEAM, AVG_FINISH), AVG_FINISH, fill = TEAM)) + 
  geom_bar(stat = "identity") + 
  ggtitle(label = "Best Average Finish - Team", subtitle = "Only teams with multiple runners") +
  labs(x = "Team", y = "Average Finish") +
  geom_text(aes(label=AVG_FINISH), position=position_dodge(width=0.9), hjust = -0.05, angle = 90) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill=FALSE)

```

# DYNAMICALLY SCRAPE TFRRS LINKS
```{r}
# # TFRRS Results Page
# #url = "https://www.tfrrs.org/results_search.html"
# url = 'https://www.tfrrs.org/results/xc/4797/2012_NCAA_Division_I_Cross_Country_Championships'
# 
# # Read in the links on the webpage
# wp = read_html(url) %>% 
#   html_nodes(xpath = "//td/a") %>% 
#   html_attr("href")
# 
# # Manipulate strings
# for ( i  in 1:length(wp) )
# {
#   temp = wp[i]
#   #temp = substring(temp, 3)
#   temp = paste0("https:", temp)
#   temp = substr(temp, 1, nchar(temp)-3)
#   wp[i] = temp
# }
```

```{r}
# Attempt to read in first runner
# runner = read_html("https://www.tfrrs.org/athletes/5684073/Colorado/Dani_Jones.html") %>%
#   html_nodes("td") %>%
#   html_text()
# 
# runner = gsub("[\t\n]", "", runner)
# runner = gsub("-", "", runner)
# runner = gsub("\\...", "", runner)
# runner = str_trim(runner, side = "both")
# 
# runner = as.data.frame(runner)
```






